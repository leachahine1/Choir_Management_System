{
    "sourceFile": "ISFM/modules/dailyAttendance/controllers/dailyAttendance.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1714942059903,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1714942457125,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,453 @@\n+<?php\r\n+if (!defined('BASEPATH')) {\r\n+    exit('No direct script access allowed');\r\n+}\r\n+\r\n+class DailyAttendance extends MX_Controller {\r\n+//    private $input;\r\n+\r\n+    /**\r\n+     * This is DailyAttendance Controller in Choir Module.\r\n+     *\r\n+     * Maps to the following URL\r\n+     * \t\thttp://rehearsalple.com/index.php/dailyAttendance\r\n+     * \t- or -  \r\n+     * \t\thttp://rehearsalple.com/index.php/dailyAttendance/index\r\n+     */\r\n+    function __construct() {\r\n+        parent::__construct();\r\n+        $this->load->model('attendancemodule');\r\n+        if (!$this->ion_auth->logged_in()) {\r\n+            redirect('auth/login');\r\n+        }\r\n+    }\r\n+\r\n+    //This function show the Choir & section for selecting Choir to take attendance \r\n+    public function selectChoirAttendance() {\r\n+        $data['s_Choir'] = $this->common->getAllData('Choir');\r\n+        $this->load->view('temp/header');\r\n+        $this->load->view('selectChoirAttendance', $data);\r\n+        $this->load->view('temp/footer');\r\n+    }\r\n+\r\n+    //This function is used for take attendence to Choir Choir_members\r\n+    public function attendance() {\r\n+        if ($this->input->post('submit', TRUE)) {\r\n+            //Whene submit the attendence information after takeing the attendence\r\n+            $i = $this->input->post('in_velu', TRUE);\r\n+            $day = date(\"d-m-Y\");\r\n+            $date = strtotime($day);\r\n+            $ChoirTitle = $this->input->post('ChoirTitle', TRUE);\r\n+            for ($x = 1; $x <= $i; $x++) {\r\n+                $roll = $this->input->post(\"roll_$x\", TRUE);\r\n+                $name = $this->input->post(\"atudentName_$x\", TRUE);\r\n+                $present = \"\";\r\n+                if ($this->input->post(\"action_$x\", TRUE)) {\r\n+                    if ($this->input->post(\"action_$x\", TRUE) === 'P') {\r\n+                        $present = \"P\";\r\n+                    } else {\r\n+                        $present = \"A\";\r\n+                    }\r\n+                }\r\n+                $userId = $this->input->post(\"userId_$x\", TRUE);\r\n+                $Choir_memberInfoId = $this->input->post(\"Choir_memberInfoId_$x\", TRUE);\r\n+                $section = $this->input->post(\"section_$x\", TRUE);\r\n+                $data = array(\r\n+                    'date' => $this->db->escape_like_str($date),\r\n+                    'user_id' => $this->db->escape_like_str($userId),\r\n+                    'Choir_member_id' => $this->db->escape_like_str($Choir_memberInfoId),\r\n+                    'Choir_title' => $this->db->escape_like_str($ChoirTitle),\r\n+                    'present_or_absent' => $this->db->escape_like_str($present),\r\n+                    'section' => $this->db->escape_like_str($section),\r\n+                    'roll_no' => $this->db->escape_like_str($roll),\r\n+                    'Choir_member_title' => $this->db->escape_like_str($name),\r\n+                );\r\n+                //insert the $data information into \"daily_attendance\" database.\r\n+                $this->db->insert('daily_attendance', $data);\r\n+                //Take Choir and attend amount monthly and make the attendence percintise monthly \r\n+                $ChoirAmountMonthly = $this->attendancemodule->ChoirAmountMonthly($Choir_memberInfoId);\r\n+                if ($this->input->post(\"action_$x\", TRUE) === 'P') {\r\n+                    $attendAmountMonthly = $this->attendancemodule->attendAmountMonthly($Choir_memberInfoId);\r\n+                } else {\r\n+                    $previousAttendAmountM = $this->attendancemodule->attendAmountMonthly($Choir_memberInfoId);\r\n+                    $todayAttendAmountM = 1;\r\n+                    $attendAmountMonthly = $previousAttendAmountM - $todayAttendAmountM;\r\n+                }\r\n+                $attendencePercenticeMonthly = $this->attendancemodule->attendPercentiseMonthly($attendAmountMonthly, $ChoirAmountMonthly);\r\n+                //Take Choir and attend amount yearly and make the attendence percintise yearly \r\n+                $ChoirAmountYearly = $this->attendancemodule->ChoirAmountYearly($Choir_memberInfoId);\r\n+                if ($this->input->post(\"action_$x\", TRUE) === 'P') {\r\n+                    $attendAmountYearly = $this->attendancemodule->attendAmountYearly($Choir_memberInfoId);\r\n+                } else {\r\n+                    $previousAttendAmountY = $this->attendancemodule->attendAmountYearly($Choir_memberInfoId);\r\n+                    $todayAttendAmountY = 1;\r\n+                    $attendAmountYearly = $previousAttendAmountY - $todayAttendAmountY;\r\n+                }\r\n+                $attendencePercenticeYearly = $this->attendancemodule->attendPercentiseYearly($attendAmountYearly, $ChoirAmountYearly);\r\n+                $data_1 = array(\r\n+                    'Choir_amount_monthly' => $this->db->escape_like_str($ChoirAmountMonthly),\r\n+                    'Choir_amount_yearly' => $this->db->escape_like_str($ChoirAmountYearly),\r\n+                    'attend_amount_monthly' => $this->db->escape_like_str($attendAmountMonthly),\r\n+                    'attend_amount_yearly' => $this->db->escape_like_str($attendAmountYearly),\r\n+                    'percentise_month' => $this->db->escape_like_str($attendencePercenticeMonthly),\r\n+                    'percentise_year' => $this->db->escape_like_str($attendencePercenticeYearly),\r\n+                );\r\n+                $this->db->update('daily_attendance', $data_1, array('Choir_member_id' => $Choir_memberInfoId, 'date' => $date));\r\n+                $data_2 = array(\r\n+                    'attendance_percentices_daily' => $this->db->escape_like_str($attendencePercenticeMonthly)\r\n+                );\r\n+                $this->db->update('Choir_Choir_members', $data_2, array('Choir_member_id' => $Choir_memberInfoId, 'Choir_title' => $ChoirTitle));\r\n+            }\r\n+            $dailyChoirAttendencePercentise = $this->attendancemodule->allChoir_membersDailyAttendence($date, $ChoirTitle);\r\n+            $yearChoirAttendencePercentise = $this->attendancemodule->allChoir_membersYearlyAttendence($date, $ChoirTitle);\r\n+            $data_3 = array(\r\n+                'attendance_percentices_daily' => $this->db->escape_like_str($dailyChoirAttendencePercentise),\r\n+                'attend_percentise_yearly' => $this->db->escape_like_str($yearChoirAttendencePercentise)\r\n+            );\r\n+            $this->db->where('Choir_title', $ChoirTitle);\r\n+            $this->db->update('Choir', $data_3);\r\n+            redirect('dailyAttendance/attendanceCompleteMessage', 'refresh');\r\n+        } else {\r\n+            //Load attendence view before takeing attendence with Choir,All section and specific Choir section\r\n+            $ChoirTitle = $this->input->post('Choir_title', TRUE);\r\n+            if ($this->input->post('section', TRUE)) {\r\n+                $Section = $this->input->post('section', TRUE);\r\n+                if ($Section == 'all') {\r\n+                    //if want any Choir's specific section's Choir_members attendence sheet,then work this erea.\r\n+                    $queryData = array();\r\n+                    $query = $this->db->get_where('Choir_Choir_members', array('Choir_title' => $ChoirTitle));\r\n+                    foreach ($query->result_array() as $row) {\r\n+                        $queryData[] = $row;\r\n+                    }$data['Choir_members'] = $queryData;\r\n+                    if (!empty($data['Choir_members'])) {\r\n+                        $this->load->view('temp/header');\r\n+                        $this->load->view('attendance', $data);\r\n+                        $this->load->view('temp/footer');\r\n+                    } else {\r\n+                        echo $ChoirTitle . ' and all section are no any Choir_member.';\r\n+                    }\r\n+                } elseif ($Section != 'all') {\r\n+                    //if want All section's Choir_members attendence sheet,then work this erea.\r\n+                    $queryData = array();\r\n+                    $query = $this->db->get_where('Choir_Choir_members', array('Choir_title' => $ChoirTitle, 'section' => $Section));\r\n+                    foreach ($query->result_array() as $row) {\r\n+                        $queryData[] = $row;\r\n+                    }$data['Choir_members'] = $queryData;\r\n+                    if (!empty($data['Choir_members'])) {\r\n+                        $this->load->view('temp/header');\r\n+                        $this->load->view('attendance', $data);\r\n+                        $this->load->view('temp/footer');\r\n+                    } else {\r\n+                        echo $ChoirTitle . ' and ' . $Section . ' section are no any Choir_member.';\r\n+                    }\r\n+                }\r\n+            } else {\r\n+                //whene want any Choir Choir_members attendence sheet only,then work this erea.\r\n+                $queryData = array();\r\n+                $query = $this->db->get_where('Choir_Choir_members', array('Choir_title' => $ChoirTitle));\r\n+                foreach ($query->result_array() as $row) {\r\n+                    $queryData[] = $row;\r\n+                }\r\n+                $data['Choir_members'] = $queryData;\r\n+                if (!empty($data['Choir_members'])) {\r\n+                    $this->load->view('temp/header');\r\n+                    $this->load->view('attendance', $data);\r\n+                    $this->load->view('temp/footer');\r\n+                } else {\r\n+                    echo $ChoirTitle . ' are no any Choir_member.';\r\n+                }\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    //This function send a message that Attendance Was completed.\r\n+    //And gives two link for re-check and can edit the attendance.\r\n+    public function attendanceCompleteMessage() {\r\n+        $this->load->view('temp/header');\r\n+        $this->load->view('attendenceCompleateMessage');\r\n+        $this->load->view('temp/footer');\r\n+    }\r\n+\r\n+    //This function is used for filtering to get Choir_members information(which Choir and which section if the section in that Choir)\r\n+    public function ajaxChoirAttendanceSection() {\r\n+        $ChoirTitle = $this->input->get('q');\r\n+        $query = $this->common->getWhere('Choir', 'Choir_title', $ChoirTitle);\r\n+        foreach ($query as $row) {\r\n+            $data = $row;\r\n+        }\r\n+        echo '<input type=\"hidden\" name=\"Choir\" value=\"' . $ChoirTitle . '\">';\r\n+        if (!empty($data['section'])) {\r\n+            $section = $data['section'];\r\n+            $sectionArray = explode(\",\", $section);\r\n+            echo '<div class=\"form-group\">\r\n+                        <label class=\"col-md-3 control-label\"></label>\r\n+                        <div class=\"col-md-4\">\r\n+                            <select name=\"section\" class=\"form-control\">\r\n+                                <option value=\"all\">' . lang('attc_1') . '</option>';\r\n+            foreach ($sectionArray as $sec) {\r\n+                echo '<option value=\"' . $sec . '\">' . $sec . '</option>';\r\n+            }\r\n+            echo '</select></div>\r\n+                    </div>';\r\n+        } else {\r\n+            $section = 'This class has no section.';\r\n+            echo '<div class=\"form-group\">\r\n+                        <label class=\"col-md-3 control-label\"></label>\r\n+                        <div class=\"col-md-6\">\r\n+                        <div class=\"alert alert-warning\">\r\n+                                <strong>Info!</strong> ' . $section . '\r\n+                        </div></div></div>';\r\n+        }\r\n+    }\r\n+\r\n+    public function selectAttendancePreview() {\r\n+        $data['s_Choir'] = $this->common->getAllData('Choir');\r\n+        $this->load->view('temp/header');\r\n+        $this->load->view('selectAttendencePreview', $data);\r\n+        $this->load->view('temp/footer');\r\n+    }\r\n+\r\n+    public function attendencePreview() {\r\n+        //Load attendence view before takeing attendence with Choir,All section and specific Choir section\r\n+        $ChoirTitle = $this->input->post('Choir_title', TRUE);\r\n+        $date = $this->input->post('date', TRUE);\r\n+        $intDate = strtotime($date);\r\n+        if ($this->input->post('section', TRUE)) {\r\n+            $Section = $this->input->post('section', TRUE);\r\n+            if ($Section == 'all') {\r\n+                //if want any Choir's specific section's Choir_members attendence sheet,then work this erea.\r\n+                $queryData = array();\r\n+                $query = $this->db->get_where('daily_attendance', array('Choir_title' => $ChoirTitle));\r\n+                foreach ($query->result_array() as $row) {\r\n+                    $queryData[] = $row;\r\n+                }$data['Choir_members'] = $queryData;\r\n+                if (!empty($data['Choir_members'])) {\r\n+                    $this->load->view('temp/header');\r\n+                    $this->load->view('attendencePreview', $data);\r\n+                    $this->load->view('temp/footer');\r\n+                } else {\r\n+                    echo $ChoirTitle . ' and all section are no any Choir_member.';\r\n+                }\r\n+            } elseif ($Section != 'all') {\r\n+                //if want All section's Choir_members attendence sheet,then work this erea.\r\n+                //if want any Choir's specific section's Choir_members attendence sheet,then work this erea.\r\n+                $queryData = array();\r\n+                $query = $this->db->get_where('daily_attendance', array('Choir_title' => $ChoirTitle,  'section' => $Section));\r\n+                foreach ($query->result_array() as $row) {\r\n+                    $queryData[] = $row;\r\n+                }\r\n+                $data['Choir_members'] = $queryData;\r\n+                if (!empty($data['Choir_members'])) {\r\n+                    $this->load->view('temp/header');\r\n+                    $this->load->view('attendencePreview', $data);\r\n+                    $this->load->view('temp/footer');\r\n+                } else {\r\n+                    echo $ChoirTitle . ' and ' . $Section . ' section are no any Choir_member.';\r\n+                }\r\n+            }\r\n+        } else {\r\n+            //whene want any Choir Choir_members attendence sheet only,then work this erea.\r\n+            $queryData = array();\r\n+            $query = $this->db->get_where('daily_attendance', array('Choir_title' => $ChoirTitle, 'date' => $intDate));\r\n+            foreach ($query->result_array() as $row) {\r\n+                $queryData[] = $row;\r\n+            }\r\n+            $data['Choir_members'] = $queryData;\r\n+            if (!empty($data['Choir_members'])) {\r\n+                $this->load->view('temp/header');\r\n+                $this->load->view('attendencePreview', $data);\r\n+                $this->load->view('temp/footer');\r\n+            } else {\r\n+                echo $ChoirTitle . ' ' . lang('attc_2');\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    //This function send Choir section to view by ajax. \r\n+    public function ajaxAttendencePreview() {\r\n+        $ChoirTitle = $this->input->get('q', TRUE);\r\n+        $query = $this->common->getWhere('Choir', 'Choir_title', $ChoirTitle);\r\n+        foreach ($query as $row) {\r\n+            $data = $row;\r\n+        }\r\n+        echo '<input type=\"hidden\" name=\"Choir\" value=\"' . $ChoirTitle . '\">';\r\n+        if (!empty($data['section'])) {\r\n+            $section = $data['section'];\r\n+            $sectionArray = explode(\",\", $section);\r\n+            echo '<div class=\"form-group\">\r\n+                        <label class=\"col-md-3 control-label\"></label>\r\n+                        <div class=\"col-md-4\">\r\n+                            <select name=\"section\" class=\"form-control\">\r\n+                                <option value=\"all\">' . lang('attc_1') . '</option>';\r\n+            foreach ($sectionArray as $sec) {\r\n+                echo '<option value=\"' . $sec . '\">' . $sec . '</option>';\r\n+            }\r\n+            echo '</select></div>\r\n+                    </div>';\r\n+        } else {\r\n+            $section = 'This class has no section.';\r\n+            echo '<div class=\"form-group\">\r\n+                        <label class=\"col-md-3 control-label\"></label>\r\n+                        <div class=\"col-md-6\">\r\n+                        <div class=\"alert alert-warning\">\r\n+                                <strong>' . lang('attc_3') . ' </strong> ' . $section . '\r\n+                        </div></div></div>';\r\n+        }\r\n+    }\r\n+\r\n+    //This function can edit and update the related table's info.\r\n+    public function editAttendance() {\r\n+        $id = $this->input->get('ghtnidjdfjkid', TRUE);\r\n+        $day = date(\"m/d/y\");\r\n+        $date = strtotime($day);\r\n+        if ($this->input->post('submit', TRUE)) {\r\n+            $Choir_memberInfoId = $this->input->post('Choir_memberInfoId', TRUE);\r\n+            $ChoirTitle = $this->input->post('ChoirTitle', TRUE);\r\n+\r\n+            $present = \"\";\r\n+            if ($this->input->post(\"action\", TRUE)) {\r\n+                if ($this->input->post(\"action\", TRUE) == 'P') {\r\n+                    $present = \"P\";\r\n+                } else {\r\n+                    $present = \"A\";\r\n+                }\r\n+            }\r\n+            //Take Choir and attend amount monthly and make the attendence percintise monthly \r\n+            $ChoirAmountMonthly = $this->attendancemodule->ChoirAmountMonthly($Choir_memberInfoId);\r\n+            if ($this->input->post(\"action\", TRUE) == 'P') {\r\n+                $previousAttendAmountM = $this->attendancemodule->attendAmountMonthly($Choir_memberInfoId);\r\n+                $todayAttendAmountM = 2;\r\n+                $attendAmountMonthly = $previousAttendAmountM + $todayAttendAmountM;\r\n+            } else {\r\n+                $previousAttendAmountM = $this->attendancemodule->attendAmountMonthly($Choir_memberInfoId);\r\n+                $todayAttendAmountM = 2;\r\n+                $attendAmountMonthly = $previousAttendAmountM - $todayAttendAmountM;\r\n+            }\r\n+            $attendencePercenticeMonthly = $this->attendancemodule->attendPercentiseMonthly($attendAmountMonthly, $ChoirAmountMonthly);\r\n+            //Take Choir and attend amount yearly and make the attendence percintise yearly \r\n+            $ChoirAmountYearly = $this->attendancemodule->ChoirAmountYearly($Choir_memberInfoId);\r\n+            if ($this->input->post(\"action\", TRUE) == 'P') {\r\n+                $previousAttendAmountY = $this->attendancemodule->attendAmountYearly($Choir_memberInfoId);\r\n+                $todayAttendAmountY = 2;\r\n+                $attendAmountYearly = $previousAttendAmountY + $todayAttendAmountY;\r\n+            } else {\r\n+                $previousAttendAmountY = $this->attendancemodule->attendAmountYearly($Choir_memberInfoId);\r\n+                $todayAttendAmountY = 2;\r\n+                $attendAmountYearly = $previousAttendAmountY - $todayAttendAmountY;\r\n+            }\r\n+            $attendencePercenticeYearly = $this->attendancemodule->attendPercentiseYearly($attendAmountYearly, $ChoirAmountYearly);\r\n+            $tableData = array(\r\n+                'present_or_absent' => $this->db->escape_like_str($present),\r\n+                'Choir_amount_monthly' => $this->db->escape_like_str($ChoirAmountMonthly),\r\n+                'Choir_amount_yearly' => $this->db->escape_like_str($ChoirAmountYearly),\r\n+                'attend_amount_monthly' => $this->db->escape_like_str($attendAmountMonthly),\r\n+                'attend_amount_yearly' => $this->db->escape_like_str($attendAmountYearly),\r\n+                'percentise_month' => $this->db->escape_like_str($attendencePercenticeMonthly),\r\n+                'percentise_year' => $this->db->escape_like_str($attendencePercenticeYearly),\r\n+            );\r\n+            $this->db->update('daily_attendance', $tableData, array('Choir_member_id' => $Choir_memberInfoId, 'date' => $date));\r\n+            $tableData_1 = array(\r\n+                'attendance_percentices_daily' => $this->db->escape_like_str($attendencePercenticeMonthly)\r\n+            );\r\n+            $this->db->update('Choir_Choir_members', $tableData_1, array('Choir_member_id' => $Choir_memberInfoId, 'Choir_title' => $ChoirTitle));\r\n+            redirect('dailyAttendance/attendanceEditCompleteMessage', 'refresh');\r\n+        } else {\r\n+            $data['editInfo'] = $this->common->getWhere('daily_attendance', 'id', $id);\r\n+            //load the attendance edit view with information.\r\n+            $this->load->view('temp/header');\r\n+            $this->load->view('editAttendance', $data);\r\n+            $this->load->view('temp/footer');\r\n+        }\r\n+    }\r\n+\r\n+    public function attendanceEditCompleteMessage() {\r\n+        $this->load->view('temp/header');\r\n+        $this->load->view('attendanceEditCompleteMessage');\r\n+        $this->load->view('temp/footer');\r\n+    }\r\n+\r\n+    //This functio check section_leader security password\r\n+    public function t_a_s_p() {\r\n+        if ($this->input->post('submit', TRUE)) {\r\n+            $password = $this->input->post('password', TRUE);\r\n+            $security = $this->db->query('SELECT t_a_s_p FROM configuration');\r\n+            foreach ($security->result_array() as $row) {\r\n+                $data = $row['t_a_s_p'];\r\n+            }\r\n+            if ($password == $data) {\r\n+                $today = strtotime(date('d-m-Y'));\r\n+                if ($this->attendancemodule->todaySection_leaderAtt($today) == 'Taken') {\r\n+                    redirect('dailyAttendance/section_leaderAttendance', 'refresh');\r\n+                } else {\r\n+                    $query = $this->db->query(\"SELECT id,username FROM users WHERE user_status='Employee' AND NOT (leave_status='Leave' AND leave_start<='$today' AND leave_end>='$today')\");\r\n+                    foreach ($query->result_array() as $row) {\r\n+                        $tData = array(\r\n+                            'year' => date('Y'),\r\n+                            'date' => strtotime(date(\"d-m-Y\")),\r\n+                            'employ_id' => $row['id'],\r\n+                            'employ_title' => $row['username'],\r\n+                            'present_or_absent' => 'Absent'\r\n+                        );\r\n+                        $this->db->insert('section_leader_attendance', $tData);\r\n+                    }\r\n+                    redirect('dailyAttendance/section_leaderAttendance', 'refresh');\r\n+                }\r\n+            } else {\r\n+                $dat['message'] = '<div class=\"alert alert-danger alert-dismissable\">\r\n+\t\t\t\t\t\t\t\t<button aria-hidden=\"true\" data-dismiss=\"alert\" class=\"close\" type=\"button\"></button>\r\n+\t\t\t\t\t\t\t\t<strong>' . lang('attc_4') . ' </strong> ' . lang('attc_5') . '\r\n+\t\t\t\t\t\t\t</div>';\r\n+                $this->load->view('temp/header');\r\n+                $this->load->view('selcetTeacAttView', $dat);\r\n+                $this->load->view('temp/footer');\r\n+            }\r\n+        } else {\r\n+            $this->load->view('temp/header');\r\n+            $this->load->view('selcetTeacAttView');\r\n+            $this->load->view('temp/footer');\r\n+        }\r\n+    }\r\n+\r\n+    //Start section_leader attendance's function now.\r\n+    //take section_leader attendance\r\n+    public function section_leaderAttendance() {\r\n+        if ($this->input->post('submit', TRUE)) {\r\n+            $query = $this->db->query('SELECT time_zone FROM configuration');\r\n+            foreach ($query->result_array() as $row) {\r\n+                $data = $row['time_zone'];\r\n+            }\r\n+            $datestring = \"%h:%i %a\";\r\n+            $now = now();\r\n+            $timezone = $data;\r\n+            $time = gmt_to_local($now, $timezone);\r\n+            $compTime = mdate($datestring, $time);\r\n+            $section_leaderAttenId = $this->input->post('section_leader', TRUE);\r\n+            if ($this->input->post('presAbsent', TRUE) == 'Absent') {\r\n+                $compTime = '';\r\n+            }\r\n+            $insertData = array(\r\n+                'id' => $section_leaderAttenId,\r\n+                'present_or_absent' => $this->input->post('presAbsent', TRUE),\r\n+                'attend_time' => $compTime\r\n+            );\r\n+            $this->db->where('id', $section_leaderAttenId);\r\n+            if ($this->db->update('section_leader_attendance', $insertData)) {\r\n+                redirect('dailyAttendance/section_leaderAttendance', 'refresh');\r\n+            }\r\n+        } else {\r\n+            $data['section_leader'] = $this->attendancemodule->section_leaderList();\r\n+            $this->load->view('temp/header');\r\n+            $this->load->view('teacAtteView', $data);\r\n+            $this->load->view('temp/footer');\r\n+        }\r\n+    }\r\n+\r\n+    //This function will return employee attendance information\r\n+    public function employe_atten_view() {\r\n+        $data['employee'] = $this->attendancemodule->attend_employe();\r\n+        $this->load->view('temp/header');\r\n+        $this->load->view('employe_atten_view', $data);\r\n+        $this->load->view('temp/footer');\r\n+    }\r\n+\r\n+}\r\n"
                }
            ],
            "date": 1714942059903,
            "name": "Commit-0",
            "content": "<?php\r\nif (!defined('BASEPATH')) {\r\n    exit('No direct script access allowed');\r\n}\r\n\r\nclass DailyAttendance extends MX_Controller {\r\n//    private $input;\r\n\r\n    /**\r\n     * This is DailyAttendance Controller in Choir Module.\r\n     *\r\n     * Maps to the following URL\r\n     * \t\thttp://rehearsalple.com/index.php/dailyAttendance\r\n     * \t- or -  \r\n     * \t\thttp://rehearsalple.com/index.php/dailyAttendance/index\r\n     */\r\n    function __construct() {\r\n        parent::__construct();\r\n        $this->load->model('attendancemodule');\r\n        if (!$this->ion_auth->logged_in()) {\r\n            redirect('auth/login');\r\n        }\r\n    }\r\n\r\n    //This function show the Choir & section for selecting Choir to take attendance \r\n    public function selectChoirAttendance() {\r\n        $data['s_Choir'] = $this->common->getAllData('Choir');\r\n        $this->load->view('temp/header');\r\n        $this->load->view('selectChoirAttendance', $data);\r\n        $this->load->view('temp/footer');\r\n    }\r\n\r\n    //This function is used for take attendence to Choir Choir_members\r\n    public function attendance() {\r\n        if ($this->input->post('submit', TRUE)) {\r\n            //Whene submit the attendence information after takeing the attendence\r\n            $i = $this->input->post('in_velu', TRUE);\r\n            $day = date(\"d-m-Y\");\r\n            $date = strtotime($day);\r\n            $ChoirTitle = $this->input->post('ChoirTitle', TRUE);\r\n            for ($x = 1; $x <= $i; $x++) {\r\n                $roll = $this->input->post(\"roll_$x\", TRUE);\r\n                $name = $this->input->post(\"atudentName_$x\", TRUE);\r\n                $present = \"\";\r\n                if ($this->input->post(\"action_$x\", TRUE)) {\r\n                    if ($this->input->post(\"action_$x\", TRUE) === 'P') {\r\n                        $present = \"P\";\r\n                    } else {\r\n                        $present = \"A\";\r\n                    }\r\n                }\r\n                $userId = $this->input->post(\"userId_$x\", TRUE);\r\n                $Choir_memberInfoId = $this->input->post(\"Choir_memberInfoId_$x\", TRUE);\r\n                $section = $this->input->post(\"section_$x\", TRUE);\r\n                $data = array(\r\n                    'date' => $this->db->escape_like_str($date),\r\n                    'user_id' => $this->db->escape_like_str($userId),\r\n                    'Choir_member_id' => $this->db->escape_like_str($Choir_memberInfoId),\r\n                    'Choir_title' => $this->db->escape_like_str($ChoirTitle),\r\n                    'present_or_absent' => $this->db->escape_like_str($present),\r\n                    'section' => $this->db->escape_like_str($section),\r\n                    'roll_no' => $this->db->escape_like_str($roll),\r\n                    'Choir_member_title' => $this->db->escape_like_str($name),\r\n                );\r\n                //insert the $data information into \"daily_attendance\" database.\r\n                $this->db->insert('daily_attendance', $data);\r\n                //Take Choir and attend amount monthly and make the attendence percintise monthly \r\n                $ChoirAmountMonthly = $this->attendancemodule->ChoirAmountMonthly($Choir_memberInfoId);\r\n                if ($this->input->post(\"action_$x\", TRUE) === 'P') {\r\n                    $attendAmountMonthly = $this->attendancemodule->attendAmountMonthly($Choir_memberInfoId);\r\n                } else {\r\n                    $previousAttendAmountM = $this->attendancemodule->attendAmountMonthly($Choir_memberInfoId);\r\n                    $todayAttendAmountM = 1;\r\n                    $attendAmountMonthly = $previousAttendAmountM - $todayAttendAmountM;\r\n                }\r\n                $attendencePercenticeMonthly = $this->attendancemodule->attendPercentiseMonthly($attendAmountMonthly, $ChoirAmountMonthly);\r\n                //Take Choir and attend amount yearly and make the attendence percintise yearly \r\n                $ChoirAmountYearly = $this->attendancemodule->ChoirAmountYearly($Choir_memberInfoId);\r\n                if ($this->input->post(\"action_$x\", TRUE) === 'P') {\r\n                    $attendAmountYearly = $this->attendancemodule->attendAmountYearly($Choir_memberInfoId);\r\n                } else {\r\n                    $previousAttendAmountY = $this->attendancemodule->attendAmountYearly($Choir_memberInfoId);\r\n                    $todayAttendAmountY = 1;\r\n                    $attendAmountYearly = $previousAttendAmountY - $todayAttendAmountY;\r\n                }\r\n                $attendencePercenticeYearly = $this->attendancemodule->attendPercentiseYearly($attendAmountYearly, $ChoirAmountYearly);\r\n                $data_1 = array(\r\n                    'Choir_amount_monthly' => $this->db->escape_like_str($ChoirAmountMonthly),\r\n                    'Choir_amount_yearly' => $this->db->escape_like_str($ChoirAmountYearly),\r\n                    'attend_amount_monthly' => $this->db->escape_like_str($attendAmountMonthly),\r\n                    'attend_amount_yearly' => $this->db->escape_like_str($attendAmountYearly),\r\n                    'percentise_month' => $this->db->escape_like_str($attendencePercenticeMonthly),\r\n                    'percentise_year' => $this->db->escape_like_str($attendencePercenticeYearly),\r\n                );\r\n                $this->db->update('daily_attendance', $data_1, array('Choir_member_id' => $Choir_memberInfoId, 'date' => $date));\r\n                $data_2 = array(\r\n                    'attendance_percentices_daily' => $this->db->escape_like_str($attendencePercenticeMonthly)\r\n                );\r\n                $this->db->update('Choir_Choir_members', $data_2, array('Choir_member_id' => $Choir_memberInfoId, 'Choir_title' => $ChoirTitle));\r\n            }\r\n            $dailyChoirAttendencePercentise = $this->attendancemodule->allChoir_membersDailyAttendence($date, $ChoirTitle);\r\n            $yearChoirAttendencePercentise = $this->attendancemodule->allChoir_membersYearlyAttendence($date, $ChoirTitle);\r\n            $data_3 = array(\r\n                'attendance_percentices_daily' => $this->db->escape_like_str($dailyChoirAttendencePercentise),\r\n                'attend_percentise_yearly' => $this->db->escape_like_str($yearChoirAttendencePercentise)\r\n            );\r\n            $this->db->where('Choir_title', $ChoirTitle);\r\n            $this->db->update('Choir', $data_3);\r\n            redirect('dailyAttendance/attendanceCompleteMessage', 'refresh');\r\n        } else {\r\n            //Load attendence view before takeing attendence with Choir,All section and specific Choir section\r\n            $ChoirTitle = $this->input->post('Choir_title', TRUE);\r\n            if ($this->input->post('section', TRUE)) {\r\n                $Section = $this->input->post('section', TRUE);\r\n                if ($Section == 'all') {\r\n                    //if want any Choir's specific section's Choir_members attendence sheet,then work this erea.\r\n                    $queryData = array();\r\n                    $query = $this->db->get_where('Choir_Choir_members', array('Choir_title' => $ChoirTitle));\r\n                    foreach ($query->result_array() as $row) {\r\n                        $queryData[] = $row;\r\n                    }$data['Choir_members'] = $queryData;\r\n                    if (!empty($data['Choir_members'])) {\r\n                        $this->load->view('temp/header');\r\n                        $this->load->view('attendance', $data);\r\n                        $this->load->view('temp/footer');\r\n                    } else {\r\n                        echo $ChoirTitle . ' and all section are no any Choir_member.';\r\n                    }\r\n                } elseif ($Section != 'all') {\r\n                    //if want All section's Choir_members attendence sheet,then work this erea.\r\n                    $queryData = array();\r\n                    $query = $this->db->get_where('Choir_Choir_members', array('Choir_title' => $ChoirTitle, 'section' => $Section));\r\n                    foreach ($query->result_array() as $row) {\r\n                        $queryData[] = $row;\r\n                    }$data['Choir_members'] = $queryData;\r\n                    if (!empty($data['Choir_members'])) {\r\n                        $this->load->view('temp/header');\r\n                        $this->load->view('attendance', $data);\r\n                        $this->load->view('temp/footer');\r\n                    } else {\r\n                        echo $ChoirTitle . ' and ' . $Section . ' section are no any Choir_member.';\r\n                    }\r\n                }\r\n            } else {\r\n                //whene want any Choir Choir_members attendence sheet only,then work this erea.\r\n                $queryData = array();\r\n                $query = $this->db->get_where('Choir_Choir_members', array('Choir_title' => $ChoirTitle));\r\n                foreach ($query->result_array() as $row) {\r\n                    $queryData[] = $row;\r\n                }\r\n                $data['Choir_members'] = $queryData;\r\n                if (!empty($data['Choir_members'])) {\r\n                    $this->load->view('temp/header');\r\n                    $this->load->view('attendance', $data);\r\n                    $this->load->view('temp/footer');\r\n                } else {\r\n                    echo $ChoirTitle . ' are no any Choir_member.';\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    //This function send a message that Attendance Was completed.\r\n    //And gives two link for re-check and can edit the attendance.\r\n    public function attendanceCompleteMessage() {\r\n        $this->load->view('temp/header');\r\n        $this->load->view('attendenceCompleateMessage');\r\n        $this->load->view('temp/footer');\r\n    }\r\n\r\n    //This function is used for filtering to get Choir_members information(which Choir and which section if the section in that Choir)\r\n    public function ajaxChoirAttendanceSection() {\r\n        $ChoirTitle = $this->input->get('q');\r\n        $query = $this->common->getWhere('Choir', 'Choir_title', $ChoirTitle);\r\n        foreach ($query as $row) {\r\n            $data = $row;\r\n        }\r\n        echo '<input type=\"hidden\" name=\"Choir\" value=\"' . $ChoirTitle . '\">';\r\n        if (!empty($data['section'])) {\r\n            $section = $data['section'];\r\n            $sectionArray = explode(\",\", $section);\r\n            echo '<div class=\"form-group\">\r\n                        <label class=\"col-md-3 control-label\"></label>\r\n                        <div class=\"col-md-4\">\r\n                            <select name=\"section\" class=\"form-control\">\r\n                                <option value=\"all\">' . lang('attc_1') . '</option>';\r\n            foreach ($sectionArray as $sec) {\r\n                echo '<option value=\"' . $sec . '\">' . $sec . '</option>';\r\n            }\r\n            echo '</select></div>\r\n                    </div>';\r\n        } else {\r\n            $section = 'This class has no section.';\r\n            echo '<div class=\"form-group\">\r\n                        <label class=\"col-md-3 control-label\"></label>\r\n                        <div class=\"col-md-6\">\r\n                        <div class=\"alert alert-warning\">\r\n                                <strong>Info!</strong> ' . $section . '\r\n                        </div></div></div>';\r\n        }\r\n    }\r\n\r\n    public function selectAttendancePreview() {\r\n        $data['s_Choir'] = $this->common->getAllData('Choir');\r\n        $this->load->view('temp/header');\r\n        $this->load->view('selectAttendencePreview', $data);\r\n        $this->load->view('temp/footer');\r\n    }\r\n\r\n    public function attendencePreview() {\r\n        //Load attendence view before takeing attendence with Choir,All section and specific Choir section\r\n        $ChoirTitle = $this->input->post('Choir_title', TRUE);\r\n        $date = $this->input->post('date', TRUE);\r\n        $intDate = strtotime($date);\r\n        if ($this->input->post('section', TRUE)) {\r\n            $Section = $this->input->post('section', TRUE);\r\n            if ($Section == 'all') {\r\n                //if want any Choir's specific section's Choir_members attendence sheet,then work this erea.\r\n                $queryData = array();\r\n                $query = $this->db->get_where('daily_attendance', array('Choir_title' => $ChoirTitle));\r\n                foreach ($query->result_array() as $row) {\r\n                    $queryData[] = $row;\r\n                }$data['Choir_members'] = $queryData;\r\n                if (!empty($data['Choir_members'])) {\r\n                    $this->load->view('temp/header');\r\n                    $this->load->view('attendencePreview', $data);\r\n                    $this->load->view('temp/footer');\r\n                } else {\r\n                    echo $ChoirTitle . ' and all section are no any Choir_member.';\r\n                }\r\n            } elseif ($Section != 'all') {\r\n                //if want All section's Choir_members attendence sheet,then work this erea.\r\n                //if want any Choir's specific section's Choir_members attendence sheet,then work this erea.\r\n                $queryData = array();\r\n                $query = $this->db->get_where('daily_attendance', array('Choir_title' => $ChoirTitle, 'date' => $intDate, 'section' => $Section));\r\n                foreach ($query->result_array() as $row) {\r\n                    $queryData[] = $row;\r\n                }\r\n                $data['Choir_members'] = $queryData;\r\n                if (!empty($data['Choir_members'])) {\r\n                    $this->load->view('temp/header');\r\n                    $this->load->view('attendencePreview', $data);\r\n                    $this->load->view('temp/footer');\r\n                } else {\r\n                    echo $ChoirTitle . ' and ' . $Section . ' section are no any Choir_member.';\r\n                }\r\n            }\r\n        } else {\r\n            //whene want any Choir Choir_members attendence sheet only,then work this erea.\r\n            $queryData = array();\r\n            $query = $this->db->get_where('daily_attendance', array('Choir_title' => $ChoirTitle, 'date' => $intDate));\r\n            foreach ($query->result_array() as $row) {\r\n                $queryData[] = $row;\r\n            }\r\n            $data['Choir_members'] = $queryData;\r\n            if (!empty($data['Choir_members'])) {\r\n                $this->load->view('temp/header');\r\n                $this->load->view('attendencePreview', $data);\r\n                $this->load->view('temp/footer');\r\n            } else {\r\n                echo $ChoirTitle . ' ' . lang('attc_2');\r\n            }\r\n        }\r\n    }\r\n\r\n    //This function send Choir section to view by ajax. \r\n    public function ajaxAttendencePreview() {\r\n        $ChoirTitle = $this->input->get('q', TRUE);\r\n        $query = $this->common->getWhere('Choir', 'Choir_title', $ChoirTitle);\r\n        foreach ($query as $row) {\r\n            $data = $row;\r\n        }\r\n        echo '<input type=\"hidden\" name=\"Choir\" value=\"' . $ChoirTitle . '\">';\r\n        if (!empty($data['section'])) {\r\n            $section = $data['section'];\r\n            $sectionArray = explode(\",\", $section);\r\n            echo '<div class=\"form-group\">\r\n                        <label class=\"col-md-3 control-label\"></label>\r\n                        <div class=\"col-md-4\">\r\n                            <select name=\"section\" class=\"form-control\">\r\n                                <option value=\"all\">' . lang('attc_1') . '</option>';\r\n            foreach ($sectionArray as $sec) {\r\n                echo '<option value=\"' . $sec . '\">' . $sec . '</option>';\r\n            }\r\n            echo '</select></div>\r\n                    </div>';\r\n        } else {\r\n            $section = 'This class has no section.';\r\n            echo '<div class=\"form-group\">\r\n                        <label class=\"col-md-3 control-label\"></label>\r\n                        <div class=\"col-md-6\">\r\n                        <div class=\"alert alert-warning\">\r\n                                <strong>' . lang('attc_3') . ' </strong> ' . $section . '\r\n                        </div></div></div>';\r\n        }\r\n    }\r\n\r\n    //This function can edit and update the related table's info.\r\n    public function editAttendance() {\r\n        $id = $this->input->get('ghtnidjdfjkid', TRUE);\r\n        $day = date(\"m/d/y\");\r\n        $date = strtotime($day);\r\n        if ($this->input->post('submit', TRUE)) {\r\n            $Choir_memberInfoId = $this->input->post('Choir_memberInfoId', TRUE);\r\n            $ChoirTitle = $this->input->post('ChoirTitle', TRUE);\r\n\r\n            $present = \"\";\r\n            if ($this->input->post(\"action\", TRUE)) {\r\n                if ($this->input->post(\"action\", TRUE) == 'P') {\r\n                    $present = \"P\";\r\n                } else {\r\n                    $present = \"A\";\r\n                }\r\n            }\r\n            //Take Choir and attend amount monthly and make the attendence percintise monthly \r\n            $ChoirAmountMonthly = $this->attendancemodule->ChoirAmountMonthly($Choir_memberInfoId);\r\n            if ($this->input->post(\"action\", TRUE) == 'P') {\r\n                $previousAttendAmountM = $this->attendancemodule->attendAmountMonthly($Choir_memberInfoId);\r\n                $todayAttendAmountM = 2;\r\n                $attendAmountMonthly = $previousAttendAmountM + $todayAttendAmountM;\r\n            } else {\r\n                $previousAttendAmountM = $this->attendancemodule->attendAmountMonthly($Choir_memberInfoId);\r\n                $todayAttendAmountM = 2;\r\n                $attendAmountMonthly = $previousAttendAmountM - $todayAttendAmountM;\r\n            }\r\n            $attendencePercenticeMonthly = $this->attendancemodule->attendPercentiseMonthly($attendAmountMonthly, $ChoirAmountMonthly);\r\n            //Take Choir and attend amount yearly and make the attendence percintise yearly \r\n            $ChoirAmountYearly = $this->attendancemodule->ChoirAmountYearly($Choir_memberInfoId);\r\n            if ($this->input->post(\"action\", TRUE) == 'P') {\r\n                $previousAttendAmountY = $this->attendancemodule->attendAmountYearly($Choir_memberInfoId);\r\n                $todayAttendAmountY = 2;\r\n                $attendAmountYearly = $previousAttendAmountY + $todayAttendAmountY;\r\n            } else {\r\n                $previousAttendAmountY = $this->attendancemodule->attendAmountYearly($Choir_memberInfoId);\r\n                $todayAttendAmountY = 2;\r\n                $attendAmountYearly = $previousAttendAmountY - $todayAttendAmountY;\r\n            }\r\n            $attendencePercenticeYearly = $this->attendancemodule->attendPercentiseYearly($attendAmountYearly, $ChoirAmountYearly);\r\n            $tableData = array(\r\n                'present_or_absent' => $this->db->escape_like_str($present),\r\n                'Choir_amount_monthly' => $this->db->escape_like_str($ChoirAmountMonthly),\r\n                'Choir_amount_yearly' => $this->db->escape_like_str($ChoirAmountYearly),\r\n                'attend_amount_monthly' => $this->db->escape_like_str($attendAmountMonthly),\r\n                'attend_amount_yearly' => $this->db->escape_like_str($attendAmountYearly),\r\n                'percentise_month' => $this->db->escape_like_str($attendencePercenticeMonthly),\r\n                'percentise_year' => $this->db->escape_like_str($attendencePercenticeYearly),\r\n            );\r\n            $this->db->update('daily_attendance', $tableData, array('Choir_member_id' => $Choir_memberInfoId, 'date' => $date));\r\n            $tableData_1 = array(\r\n                'attendance_percentices_daily' => $this->db->escape_like_str($attendencePercenticeMonthly)\r\n            );\r\n            $this->db->update('Choir_Choir_members', $tableData_1, array('Choir_member_id' => $Choir_memberInfoId, 'Choir_title' => $ChoirTitle));\r\n            redirect('dailyAttendance/attendanceEditCompleteMessage', 'refresh');\r\n        } else {\r\n            $data['editInfo'] = $this->common->getWhere('daily_attendance', 'id', $id);\r\n            //load the attendance edit view with information.\r\n            $this->load->view('temp/header');\r\n            $this->load->view('editAttendance', $data);\r\n            $this->load->view('temp/footer');\r\n        }\r\n    }\r\n\r\n    public function attendanceEditCompleteMessage() {\r\n        $this->load->view('temp/header');\r\n        $this->load->view('attendanceEditCompleteMessage');\r\n        $this->load->view('temp/footer');\r\n    }\r\n\r\n    //This functio check section_leader security password\r\n    public function t_a_s_p() {\r\n        if ($this->input->post('submit', TRUE)) {\r\n            $password = $this->input->post('password', TRUE);\r\n            $security = $this->db->query('SELECT t_a_s_p FROM configuration');\r\n            foreach ($security->result_array() as $row) {\r\n                $data = $row['t_a_s_p'];\r\n            }\r\n            if ($password == $data) {\r\n                $today = strtotime(date('d-m-Y'));\r\n                if ($this->attendancemodule->todaySection_leaderAtt($today) == 'Taken') {\r\n                    redirect('dailyAttendance/section_leaderAttendance', 'refresh');\r\n                } else {\r\n                    $query = $this->db->query(\"SELECT id,username FROM users WHERE user_status='Employee' AND NOT (leave_status='Leave' AND leave_start<='$today' AND leave_end>='$today')\");\r\n                    foreach ($query->result_array() as $row) {\r\n                        $tData = array(\r\n                            'year' => date('Y'),\r\n                            'date' => strtotime(date(\"d-m-Y\")),\r\n                            'employ_id' => $row['id'],\r\n                            'employ_title' => $row['username'],\r\n                            'present_or_absent' => 'Absent'\r\n                        );\r\n                        $this->db->insert('section_leader_attendance', $tData);\r\n                    }\r\n                    redirect('dailyAttendance/section_leaderAttendance', 'refresh');\r\n                }\r\n            } else {\r\n                $dat['message'] = '<div class=\"alert alert-danger alert-dismissable\">\r\n\t\t\t\t\t\t\t\t<button aria-hidden=\"true\" data-dismiss=\"alert\" class=\"close\" type=\"button\"></button>\r\n\t\t\t\t\t\t\t\t<strong>' . lang('attc_4') . ' </strong> ' . lang('attc_5') . '\r\n\t\t\t\t\t\t\t</div>';\r\n                $this->load->view('temp/header');\r\n                $this->load->view('selcetTeacAttView', $dat);\r\n                $this->load->view('temp/footer');\r\n            }\r\n        } else {\r\n            $this->load->view('temp/header');\r\n            $this->load->view('selcetTeacAttView');\r\n            $this->load->view('temp/footer');\r\n        }\r\n    }\r\n\r\n    //Start section_leader attendance's function now.\r\n    //take section_leader attendance\r\n    public function section_leaderAttendance() {\r\n        if ($this->input->post('submit', TRUE)) {\r\n            $query = $this->db->query('SELECT time_zone FROM configuration');\r\n            foreach ($query->result_array() as $row) {\r\n                $data = $row['time_zone'];\r\n            }\r\n            $datestring = \"%h:%i %a\";\r\n            $now = now();\r\n            $timezone = $data;\r\n            $time = gmt_to_local($now, $timezone);\r\n            $compTime = mdate($datestring, $time);\r\n            $section_leaderAttenId = $this->input->post('section_leader', TRUE);\r\n            if ($this->input->post('presAbsent', TRUE) == 'Absent') {\r\n                $compTime = '';\r\n            }\r\n            $insertData = array(\r\n                'id' => $section_leaderAttenId,\r\n                'present_or_absent' => $this->input->post('presAbsent', TRUE),\r\n                'attend_time' => $compTime\r\n            );\r\n            $this->db->where('id', $section_leaderAttenId);\r\n            if ($this->db->update('section_leader_attendance', $insertData)) {\r\n                redirect('dailyAttendance/section_leaderAttendance', 'refresh');\r\n            }\r\n        } else {\r\n            $data['section_leader'] = $this->attendancemodule->section_leaderList();\r\n            $this->load->view('temp/header');\r\n            $this->load->view('teacAtteView', $data);\r\n            $this->load->view('temp/footer');\r\n        }\r\n    }\r\n\r\n    //This function will return employee attendance information\r\n    public function employe_atten_view() {\r\n        $data['employee'] = $this->attendancemodule->attend_employe();\r\n        $this->load->view('temp/header');\r\n        $this->load->view('employe_atten_view', $data);\r\n        $this->load->view('temp/footer');\r\n    }\r\n\r\n}\r\n"
        }
    ]
}